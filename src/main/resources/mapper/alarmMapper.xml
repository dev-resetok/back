<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.back.mapper.alarm.AlarmMapper">

    <insert id="insertVtApplicationAlarm" parameterType="map">
        INSERT INTO tbl_vt_alarm (member_id, vt_application_id, vt_id, alarm_content, created_date, is_read)
        SELECT a.member_id, a.id, a.vt_id, #{content}, current_timestamp, FALSE
        FROM tbl_vt_application a
        WHERE a.id = #{vtApplicationId}
    </insert>

    <insert id="insertDonationAlarm">
        INSERT INTO tbl_donation_alarm (member_id, donation_id, alarm_content, created_date, is_read)
        VALUES (#{memberId}, #{donationId}, #{content}, current_timestamp, FALSE)
    </insert>

    <insert id="insertSupportAlarm">
        INSERT INTO tbl_support_alarm (member_id, support_id, alarm_content, created_date, is_read)
        VALUES (#{memberId}, #{supportId}, #{content}, current_timestamp, FALSE)
    </insert>

    <insert id="insertReplyAlarm">
        INSERT INTO tbl_reply_alarm (member_id, reply_id, alarm_content, created_date, is_read)
        VALUES (#{memberId}, #{replyId}, #{content}, current_timestamp, FALSE)
    </insert>

    <select id="selectAlarmsByMemberId" resultType="alarmDTO">
        SELECT id, alarm_content, member_id, created_date, is_read
        FROM (
                 SELECT id, alarm_content, member_id, created_date, is_read
                 FROM tbl_vt_alarm
                 WHERE member_id = #{memberId}

                 UNION ALL

                 SELECT id, alarm_content, member_id, created_date, is_read
                 FROM tbl_donation_alarm
                 WHERE member_id = #{memberId}

                 UNION ALL

                 SELECT id, alarm_content, member_id, created_date, is_read
                 FROM tbl_support_alarm
                 WHERE member_id = #{memberId}

                 UNION ALL

                 SELECT id, alarm_content, member_id, created_date, is_read
                 FROM tbl_reply_alarm
                 WHERE member_id = #{memberId}
             ) AS alarms
        ORDER BY created_date DESC
        LIMIT 10
    </select>

    <select id="selectAlarmsByMemberId7" resultType="alarmDTO">
        SELECT id, alarm_content, member_id, created_date, is_read
        FROM (
                 SELECT id, alarm_content, member_id, created_date, is_read
                 FROM tbl_vt_alarm
                 WHERE member_id = #{memberId}

                 UNION ALL

                 SELECT id, alarm_content, member_id, created_date, is_read
                 FROM tbl_donation_alarm
                 WHERE member_id = #{memberId}

                 UNION ALL

                 SELECT id, alarm_content, member_id, created_date, is_read
                 FROM tbl_support_alarm
                 WHERE member_id = #{memberId}

                 UNION ALL

                 SELECT id, alarm_content, member_id, created_date, is_read
                 FROM tbl_reply_alarm
                 WHERE member_id = #{memberId}
             ) AS alarms
        ORDER BY created_date DESC
        LIMIT 8
    </select>

    <update id="updateAlarmIsRead">
        UPDATE tbl_vt_alarm SET is_read = TRUE WHERE id = #{id} AND member_id = #{memberId};
        UPDATE tbl_donation_alarm SET is_read = TRUE WHERE id = #{id} AND member_id = #{memberId};
        UPDATE tbl_support_alarm SET is_read = TRUE WHERE id = #{id} AND member_id = #{memberId};
        UPDATE tbl_reply_alarm SET is_read = TRUE WHERE id = #{id} AND member_id = #{memberId};
    </update>

</mapper>
