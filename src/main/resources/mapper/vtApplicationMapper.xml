<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.back.mapper.vt_application.VtApplicationMapper">

    <insert id="insert" parameterType="vtApplicationDTO">
        INSERT INTO tbl_vt_application(
            id,
            application_status,
            vt_id,
            member_id
        ) VALUES (
                     #{id},
                     #{applicationStatus},
                     #{vtId},
                     #{memberId}
                 )
    </insert>

    <select id="selectById" parameterType="long" resultType="vtApplicationDTO">
        SELECT
        a.id,
        p.created_date AS applicationDate,
        a.application_status AS applicationStatus,
        a.vt_id AS vtId,
        a.member_id AS memberId
        FROM
        tbl_vt_application a
        JOIN tbl_vt v ON a.vt_id = v.id
        JOIN tbl_post p ON v.id = p.id
        WHERE
        a.id = #{id}
    </select>

    <select id="selectAll" resultType="vtApplicationDTO">
        SELECT
        a.id,
        p.created_date AS applicationDate,
        a.application_status AS applicationStatus,
        a.vt_id AS vtId,
        a.member_id AS memberId
        FROM
        tbl_vt_application a
        JOIN tbl_vt v ON a.vt_id = v.id
        JOIN tbl_post p ON v.id = p.id
    </select>

    <update id="update" parameterType="vtApplicationDTO">
        UPDATE tbl_vt_application
        SET
            application_status = #{applicationStatus},
            vt_id = #{vtId},
            member_id = #{memberId}
        WHERE id = #{id}
    </update>

    <delete id="deleteById" parameterType="long">
        DELETE FROM tbl_vt_application
        WHERE id = #{id}
    </delete>

    <!-- 특정 게시글에 지원한 사용자 목록 조회 -->
    <select id="selectByVtId" parameterType="long" resultType="com.app.back.domain.vt_application.VtApplicationDTO">
        SELECT
        a.id,
        p.created_date AS applicationDate, <!-- tbl_post의 created_date 사용 -->
        a.application_status AS applicationStatus,
        a.vt_id AS vtId,
        a.member_id AS memberId
        FROM
        tbl_vt_application a
        JOIN tbl_vt v ON a.vt_id = v.id
        JOIN tbl_post p ON v.id = p.id
        WHERE
        a.vt_id = #{vtId}
        ORDER BY
        p.created_date DESC <!-- created_date 기준 정렬 -->
    </select>

    <!-- 특정 게시글에 지원한 사용자 수 조회 -->
    <select id="countByVtId" parameterType="long" resultType="int">
        SELECT COUNT(*) FROM tbl_vt_application WHERE vt_id = #{vtId}
    </select>

    <!-- 지원자 상태 업데이트 (승인/거절) -->
    <update id="updateApplicationStatus" parameterType="map">
        UPDATE tbl_vt_application
        SET application_status = #{status}
        WHERE id = #{applicationId}
    </update>
</mapper>
